---
# Sync secrets from Bitwarden to Vault
# Usage: make sync-secrets
#
# Requires: BW_SESSION environment variable
# Run: export BW_SESSION=$(bw unlock --raw)

- name: Sync Secrets from Bitwarden to Vault
  hosts: localhost
  connection: local

  vars:
    vault_addr: "http://100.75.14.19:8200"
    vault_token: "{{ lookup('file', 'bootstrap/.vault-keys') | regex_search('Root Token: (.+)', '\\1') | first }}"

  tasks:
    - name: Check BW_SESSION is set
      fail:
        msg: "BW_SESSION not set. Run: export BW_SESSION=$(bw unlock --raw)"
      when: lookup('env', 'BW_SESSION') == ''

    - name: Get ProtonVPN WireGuard key from Bitwarden
      command: bw get item "ProtonVPN WireGuard" --session "{{ lookup('env', 'BW_SESSION') }}"
      register: bw_vpn
      changed_when: false
      failed_when: false

    - name: Parse WireGuard key
      set_fact:
        wireguard_key: "{{ (bw_vpn.stdout | from_json).notes }}"
      when: bw_vpn.rc == 0

    - name: Store VPN secrets in Vault
      uri:
        url: "{{ vault_addr }}/v1/secret/data/vpn"
        method: POST
        headers:
          X-Vault-Token: "{{ vault_token }}"
        body_format: json
        body:
          data:
            wireguard_private_key: "{{ wireguard_key }}"
            server_countries: "Denmark"
        status_code: [200, 204]
      when: wireguard_key is defined

    - name: Show result
      debug:
        msg: "{{ 'Secrets synced to Vault!' if wireguard_key is defined else 'No WireGuard key found in Bitwarden. Create a Secure Note named \"ProtonVPN WireGuard\" with the key in notes.' }}"
