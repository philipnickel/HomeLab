---
- name: Ensure Consul data directory exists
  file:
    path: "{{ consul_data_dir }}"
    state: directory
    owner: consul
    group: consul
    mode: '0755'

- name: Deploy Consul configuration
  template:
    src: consul.hcl.j2
    dest: "{{ consul_config_dir }}/consul.hcl"
    owner: consul
    group: consul
    mode: '0640'

- name: Enable Consul service
  systemd:
    name: consul
    enabled: true

- name: Start Consul
  shell: systemctl start consul
  async: 10
  poll: 0

- name: Wait for Consul to be ready
  uri:
    url: http://127.0.0.1:8500/v1/status/leader
  register: result
  until: result.status == 200
  retries: 30
  delay: 2
