---
- name: Install Vault
  apt:
    name: vault
    state: present
    update_cache: true

- name: Ensure Vault data directory exists
  file:
    path: "{{ vault_data_dir }}"
    state: directory
    owner: vault
    group: vault
    mode: '0755'

- name: Deploy Vault configuration
  template:
    src: vault.hcl.j2
    dest: "{{ vault_config_dir }}/vault.hcl"
    owner: vault
    group: vault
    mode: '0640'

- name: Enable Vault service
  systemd:
    name: vault
    enabled: true

- name: Start Vault
  shell: systemctl start vault
  async: 10
  poll: 0

- name: Wait for Vault to be ready
  uri:
    url: http://127.0.0.1:8200/v1/sys/health
    status_code: [200, 429, 472, 473, 501, 503]
  register: result
  until: result.status in [200, 429, 472, 473, 501, 503]
  retries: 30
  delay: 2
