---
# HomeLab Bootstrap - Consul & Nomad
# Prerequisite: Tailscale configured on target machine
#
# Usage: make bootstrap

- name: Setup HomeLab Server
  hosts: servers
  become: true

  pre_tasks:
    - name: Verify Tailscale is running
      command: tailscale status
      changed_when: false

    - name: Add HashiCorp GPG key
      apt_key:
        url: https://apt.releases.hashicorp.com/gpg
        state: present

    - name: Add HashiCorp repository
      apt_repository:
        repo: "deb https://apt.releases.hashicorp.com {{ ansible_distribution_release }} main"
        state: present

    - name: Install required packages
      apt:
        name:
          - curl
          - unzip
          - jq
        state: present
        update_cache: true

    - name: Create internal storage directories
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ internal_volume_dir }}/config"
        - "{{ internal_volume_dir }}/downloads"

    - name: Create external storage directories
      file:
        path: "{{ external_t7_dir }}/media"
        state: directory
        mode: '0755'

  roles:
    - consul
    - nomad

  post_tasks:
    - name: Show service URLs
      debug:
        msg: |
          Services running:
            Consul: http://{{ tailscale_ip }}:8500
            Nomad:  http://{{ tailscale_ip }}:4646

          Next steps:
            1. Deploy jobs: make deploy


- name: Setup Nomad Client
  hosts: clients

  pre_tasks:
    - name: Verify Tailscale is running
      command: tailscale status
      changed_when: false

  roles:
    - smb_mount
    - nomad_client

  post_tasks:
    - name: Show client status
      debug:
        msg: |
          Nomad client configured!

          SMB mount: {{ smb_mount_point }}
          Host volumes: {{ nomad_host_volumes | map(attribute='name') | list }}

          To start/restart Nomad client:
            brew services restart nomad
