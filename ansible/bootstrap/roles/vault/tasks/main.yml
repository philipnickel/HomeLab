---
- name: Install Vault
  apt:
    name: vault
    state: present
    update_cache: true

- name: Create data directory
  file:
    path: /opt/vault/data
    state: directory
    owner: vault
    group: vault
    mode: '0755'

- name: Create config directory
  file:
    path: /etc/vault.d
    state: directory
    owner: vault
    group: vault
    mode: '0755'

- name: Deploy Vault config
  template:
    src: vault.hcl.j2
    dest: /etc/vault.d/vault.hcl
    owner: vault
    group: vault
    mode: '0640'
  notify: restart vault

- name: Create systemd service
  template:
    src: vault.service.j2
    dest: /etc/systemd/system/vault.service
    mode: '0644'
  notify: restart vault

- name: Start and enable Vault
  systemd:
    name: vault
    state: started
    enabled: true
    daemon_reload: true
  async: 10
  poll: 0

- name: Wait for Vault to be ready
  uri:
    url: "http://127.0.0.1:8200/v1/sys/health"
    method: GET
    status_code: [200, 429, 472, 473, 501, 503]
  register: vault_health
  until: vault_health.status is defined
  retries: 30
  delay: 2

- name: Check if Vault is initialized
  uri:
    url: "http://127.0.0.1:8200/v1/sys/init"
    method: GET
  register: vault_init_status

- name: Initialize Vault
  uri:
    url: "http://127.0.0.1:8200/v1/sys/init"
    method: PUT
    body_format: json
    body:
      secret_shares: 3
      secret_threshold: 2
  register: vault_init
  when: not vault_init_status.json.initialized

- name: Save Vault keys locally
  copy:
    content: |
      # Vault Unseal Keys - KEEP THIS SAFE!
      # Generated: {{ ansible_date_time.iso8601 }}

      Unseal Key 1: {{ vault_init.json.keys_base64[0] }}
      Unseal Key 2: {{ vault_init.json.keys_base64[1] }}
      Unseal Key 3: {{ vault_init.json.keys_base64[2] }}

      Root Token: {{ vault_init.json.root_token }}
    dest: "{{ playbook_dir }}/../.vault-keys"
    mode: '0600'
  delegate_to: localhost
  become: false
  when: vault_init.json is defined and vault_init.json.keys_base64 is defined

- name: Show Vault keys location
  debug:
    msg: |
      VAULT KEYS SAVED TO: {{ playbook_dir }}/../.vault-keys

      BACK THIS FILE UP AND KEEP IT SAFE!
  when: vault_init.json is defined and vault_init.json.keys_base64 is defined

- name: Check if Vault is sealed
  uri:
    url: "http://127.0.0.1:8200/v1/sys/seal-status"
    method: GET
  register: vault_seal_status

- name: Check if vault keys file exists
  stat:
    path: "{{ playbook_dir }}/../.vault-keys"
  delegate_to: localhost
  become: false
  register: vault_keys_stat
  when: vault_seal_status.json.sealed

- name: Read saved Vault keys
  slurp:
    src: "{{ playbook_dir }}/../.vault-keys"
  delegate_to: localhost
  become: false
  register: vault_keys_file
  when: vault_seal_status.json.sealed and vault_keys_stat.stat.exists

- name: Parse unseal keys
  set_fact:
    unseal_key_1: "{{ vault_keys_file.content | b64decode | regex_search('Unseal Key 1: (.+)', '\\1') | first }}"
    unseal_key_2: "{{ vault_keys_file.content | b64decode | regex_search('Unseal Key 2: (.+)', '\\1') | first }}"
  when: vault_seal_status.json.sealed and vault_keys_stat.stat.exists

- name: Unseal Vault (key 1)
  uri:
    url: "http://127.0.0.1:8200/v1/sys/unseal"
    method: PUT
    body_format: json
    body:
      key: "{{ unseal_key_1 }}"
  when: vault_seal_status.json.sealed and vault_keys_stat.stat.exists

- name: Unseal Vault (key 2)
  uri:
    url: "http://127.0.0.1:8200/v1/sys/unseal"
    method: PUT
    body_format: json
    body:
      key: "{{ unseal_key_2 }}"
  when: vault_seal_status.json.sealed and vault_keys_stat.stat.exists

- name: Warn if Vault is sealed but no keys file
  fail:
    msg: |
      Vault is sealed but no keys file found at .vault-keys

      Either:
      1. Provide the unseal keys manually: vault operator unseal
      2. Re-initialize Vault (DESTROYS DATA):
         ssh homelab 'sudo rm -rf /opt/vault/data/*'
         make bootstrap
  when: vault_seal_status.json.sealed and not vault_keys_stat.stat.exists

- name: Verify Vault is unsealed
  uri:
    url: "http://127.0.0.1:8200/v1/sys/seal-status"
    method: GET
  register: vault_final_status
  failed_when: vault_final_status.json.sealed
