name: Deploy Nomad Jobs

on:
  push:
    branches: [main]
    paths:
      - 'nomad_jobs/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:
    inputs:
      job:
        description: 'Specific job to deploy (leave empty for all)'
        required: false
        type: choice
        options:
          - all
          - traefik
          - vpn
          - jellyfin

env:
  NOMAD_ADDR: ${{ secrets.NOMAD_ADDR }}

jobs:
  validate:
    name: Validate Jobs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Nomad
        uses: hashicorp/setup-nomad@main

      - name: Validate traefik
        run: nomad job validate nomad_jobs/core/traefik.nomad.hcl

      - name: Validate vpn
        env:
          NOMAD_VAR_wireguard_private_key: "validation-placeholder"
        run: nomad job validate nomad_jobs/core/vpn.nomad.hcl

      - name: Validate jellyfin
        run: nomad job validate nomad_jobs/media/jellyfin.nomad.hcl

  deploy-traefik:
    name: Deploy Traefik
    needs: validate
    runs-on: ubuntu-latest
    if: github.event.inputs.job == 'all' || github.event.inputs.job == 'traefik' || github.event.inputs.job == ''
    steps:
      - uses: actions/checkout@v4

      - name: Setup Nomad
        uses: hashicorp/setup-nomad@main

      - name: Plan traefik
        id: plan
        run: |
          set +e
          OUTPUT=$(nomad job plan nomad_jobs/core/traefik.nomad.hcl 2>&1)
          EXIT_CODE=$?
          echo "$OUTPUT"

          # Exit code 0 = no changes, 1 = changes pending, other = error
          if [ $EXIT_CODE -eq 0 ]; then
            echo "no_changes=true" >> $GITHUB_OUTPUT
          elif [ $EXIT_CODE -eq 1 ]; then
            INDEX=$(echo "$OUTPUT" | grep -oP 'check-index \K\d+' | tail -1)
            echo "check_index=$INDEX" >> $GITHUB_OUTPUT
            echo "no_changes=false" >> $GITHUB_OUTPUT
          else
            exit $EXIT_CODE
          fi

      - name: Deploy traefik
        if: steps.plan.outputs.no_changes != 'true'
        run: |
          nomad job run -check-index ${{ steps.plan.outputs.check_index }} nomad_jobs/core/traefik.nomad.hcl

  deploy-vpn:
    name: Deploy VPN Stack
    needs: [validate, deploy-traefik]
    runs-on: ubuntu-latest
    if: github.event.inputs.job == 'all' || github.event.inputs.job == 'vpn' || github.event.inputs.job == ''
    env:
      NOMAD_VAR_wireguard_private_key: ${{ secrets.WIREGUARD_PRIVATE_KEY }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Nomad
        uses: hashicorp/setup-nomad@main

      - name: Plan vpn
        id: plan
        run: |
          set +e
          OUTPUT=$(nomad job plan nomad_jobs/core/vpn.nomad.hcl 2>&1)
          EXIT_CODE=$?
          echo "$OUTPUT"

          if [ $EXIT_CODE -eq 0 ]; then
            echo "no_changes=true" >> $GITHUB_OUTPUT
          elif [ $EXIT_CODE -eq 1 ]; then
            INDEX=$(echo "$OUTPUT" | grep -oP 'check-index \K\d+' | tail -1)
            echo "check_index=$INDEX" >> $GITHUB_OUTPUT
            echo "no_changes=false" >> $GITHUB_OUTPUT
          else
            exit $EXIT_CODE
          fi

      - name: Deploy vpn
        if: steps.plan.outputs.no_changes != 'true'
        run: |
          nomad job run -check-index ${{ steps.plan.outputs.check_index }} nomad_jobs/core/vpn.nomad.hcl

  deploy-jellyfin:
    name: Deploy Jellyfin
    needs: [validate, deploy-traefik]
    runs-on: ubuntu-latest
    if: github.event.inputs.job == 'all' || github.event.inputs.job == 'jellyfin' || github.event.inputs.job == ''
    steps:
      - uses: actions/checkout@v4

      - name: Setup Nomad
        uses: hashicorp/setup-nomad@main

      - name: Plan jellyfin
        id: plan
        run: |
          set +e
          OUTPUT=$(nomad job plan nomad_jobs/media/jellyfin.nomad.hcl 2>&1)
          EXIT_CODE=$?
          echo "$OUTPUT"

          if [ $EXIT_CODE -eq 0 ]; then
            echo "no_changes=true" >> $GITHUB_OUTPUT
          elif [ $EXIT_CODE -eq 1 ]; then
            INDEX=$(echo "$OUTPUT" | grep -oP 'check-index \K\d+' | tail -1)
            echo "check_index=$INDEX" >> $GITHUB_OUTPUT
            echo "no_changes=false" >> $GITHUB_OUTPUT
          else
            exit $EXIT_CODE
          fi

      - name: Deploy jellyfin
        if: steps.plan.outputs.no_changes != 'true'
        run: |
          nomad job run -check-index ${{ steps.plan.outputs.check_index }} nomad_jobs/media/jellyfin.nomad.hcl
